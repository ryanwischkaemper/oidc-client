!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?b(exports,require("crypto-lib"),require("rsa-lib")):"function"==typeof define&&define.amd?define(["exports","crypto-lib","rsa-lib"],b):b(a.IdentityModel=a.IdentityModel||{},a.cryptoLib,a.rsaLib)}(this,function(a,b,c){"use strict";function d(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}function e(a,b,c){return b&&d(a.prototype,b),c&&d(a,c),a}var f=function(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")},g=function(){function a(){f(this,a)}return e(a,null,[{key:"copy",value:function(a,b){b=b||{};for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}},{key:"rand",value:function(){return((Date.now()+Math.random())*Math.random()).toString().replace(".","")}},{key:"parseOidcResult",value:function(a){a=a||location.hash;var b=a.lastIndexOf("#");b>=0&&(a=a.substr(b+1));for(var c,d={},e=/([^&=]+)=([^&]*)/g,f=0;c=e.exec(a);)if(d[decodeURIComponent(c[1])]=decodeURIComponent(c[2]),f++>50)return{error:"Response exceeded expected number of parameters"};for(var g in d)return d}}]),a}(),h=function(){function a(){f(this,a)}return e(a,[{key:"setHeaders",value:function(a,b){for(var c=Object.keys(b),d=0;d<c.length;d++){var e=c[d],f=b[e];a.setRequestHeader(e,f)}}},{key:"getJSON",value:function(a,b){var c=this;return new Promise(function(d,e){try{var f=new XMLHttpRequest;f.open("GET",a),f.responseType="json",b&&b.headers&&c.setHeaders(f,b.headers),f.onload=function(){try{if(200===f.status){var a="";a=window.XDomainRequest?f.responseText:f.response,"string"==typeof a&&(a=JSON.parse(a)),d(a)}else e(Error(f.statusText+"("+f.status+")"))}catch(b){e(b)}},f.onerror=function(){e(Error("Network error"))},f.send()}catch(g){return e(g)}})}}]),a}(),i=function(){function a(b){f(this,a),this.httpRequest=new h,this._settings=b||{},this._settings.request_state_key||(this._settings.request_state_key="OidcClient.request_state"),this._settings.request_state_store||(this._settings.request_state_store=window.localStorage),"undefined"==typeof this._settings.load_user_profile&&(this._settings.load_user_profile=!0),"undefined"==typeof this._settings.filter_protocol_claims&&(this._settings.filter_protocol_claims=!0),this._settings.authority&&this._settings.authority.indexOf(".well-known/openid-configuration")<0&&("/"!==this._settings.authority[this._settings.authority.length-1]&&(this._settings.authority+="/"),this._settings.authority+=".well-known/openid-configuration"),this._settings.response_type||(this._settings.response_type="id_token token")}return e(a,[{key:"getJson",value:function(a,b){var c={};return b&&(c.headers={Authorization:"Bearer "+b}),this._httpRequest.getJSON(a,c)}},{key:"loadMetadataAsync",value:function(){var a=this._settings;return a.metadata?Promise.resolve(a.metadata):a.authority?this.getJson(a.authority).then(function(b){return a.metadata=b,b})["catch"](function(a){return Promise.reject("Failed to load metadata ("+a&&a.message+")")}):Promise.reject("No authority configured")}},{key:"loadX509SigningKeyAsync",value:function(){function a(a){if(!a.keys||!a.keys.length)return Promise.reject("Signing keys empty");var b=a.keys[0];return"RSA"!==b.kty?Promise.reject("Signing key not RSA"):b.x5c&&b.x5c.length?Promise.resolve(b.x5c[0]):Promise.reject("RSA keys empty")}var b=this,c=this._settings;return c.jwks?a(c.jwks):this.loadMetadataAsync().then(function(d){return d.jwks_uri?b.getJson(d.jwks_uri).then(function(b){return c.jwks=b,a(b)})["catch"](function(a){return Promise.reject("Failed to load signing keys ("+a&&a.message+")")}):Promise.reject("Metadata does not contain jwks_uri")})}},{key:"loadUserProfile",value:function(a,b){var c=this;return this.loadMetadataAsync().then(function(b){return b.userinfo_endpoint?c.getJson(b.userinfo_endpoint,a):Promise.reject("Metadata does not contain userinfo_endpoint")})}},{key:"loadAuthorizationEndpoint",value:function(){return this._settings.authorization_endpoint?Promise.resolve(this._settings.authorization_endpoint):this._settings.authority?this.loadMetadataAsync().then(function(a){return a.authorization_endpoint?a.authorization_endpoint:Promise.reject("Metadata does not contain authorization_endpoint")}):Promise.reject("No authorization_endpoint configured")}},{key:"createTokenRequestAsync",value:function(){var a=this,b=this._settings;return this.loadAuthorizationEndpoint().then(function(c){var d=g.rand(),e=c+"?state="+encodeURIComponent(d);if(a.isOidc){var f=g.rand();e+="&nonce="+encodeURIComponent(f)}var h=["client_id","redirect_uri","response_type","scope"];h.forEach(function(a){var c=b[a];c&&(e+="&"+a+"="+encodeURIComponent(c))});var i=["prompt","display","max_age","ui_locales","id_token_hint","login_hint","acr_values"];i.forEach(function(a){var c=b[a];c&&(e+="&"+a+"="+encodeURIComponent(c))});var j={oidc:a.isOidc,oauth:a.isOAuth,state:d};return f&&(j.nonce=f),b.request_state_store.setItem(b.request_state_key,JSON.stringify(j)),{request_state:j,url:e}})}},{key:"createLogoutRequestAsync",value:function(a){var b=this._settings;return this.loadMetadataAsync().then(function(c){if(!c.end_session_endpoint)return Promise.reject("No end_session_endpoint in metadata");var d=c.end_session_endpoint;return a&&b.post_logout_redirect_uri&&(d+="?post_logout_redirect_uri="+encodeURIComponent(b.post_logout_redirect_uri),d+="&id_token_hint="+encodeURIComponent(a)),d})}},{key:"validateIdTokenAsync",value:function(a,b,c){var d=this,e=d._settings;return d.loadX509SigningKeyAsync().then(function(f){var h=new KJUR.jws.JWS;if(h.verifyJWSByPemX509Cert(a,f)){var i=JSON.parse(h.parsedJWS.payloadS);return b!==i.nonce?Promise.reject("Invalid nonce"):d.loadMetadataAsync().then(function(a){if(i.iss!==a.issuer)return Promise.reject("Invalid issuer");if(i.aud!==e.client_id)return Promise.reject("Invalid audience");var b=parseInt((Date.now()/1e3).toString()),f=b-i.iat;return f>300?Promise.reject("Token issued too long ago"):i.exp<b?Promise.reject("Token expired"):c&&e.load_user_profile?d.loadUserProfile(c,i).then(function(a){return g.copy(a,i)}):i})}return Promise.reject("JWT failed to validate")})}},{key:"validateAccessTokenAsync",value:function(a,b){if(!a.at_hash)return Promise.reject("No at_hash in id_token");var c=KJUR.crypto.Util.sha256(b),d=c.substr(0,c.length/2),e=hextob64u(d);return e!==a.at_hash?Promise.reject("at_hash failed to validate"):Promise.resolve()}},{key:"validateIdTokenAndAccessTokenAsync",value:function(a,b,c){var d=this;return this.validateIdTokenAsync(a,b,c).then(function(a){return d.validateAccessTokenAsync(a,c).then(function(){return a})})}},{key:"processResponseAsync",value:function(a){var b=this._settings,c=b.request_state_store.getItem(b.request_state_key);if(b.request_state_store.removeItem(b.request_state_key),!c)return Promise.reject("No request state loaded");if(c=JSON.parse(c),!c)return Promise.reject("No request state loaded");if(!c.state)return Promise.reject("No state loaded");var d=g.parseOidcResult(a);if(!d)return Promise.reject("No OIDC response");if(d.error)return Promise.reject(d.error);if(d.state!==c.state)return Promise.reject("Invalid state");if(c.oidc){if(!d.id_token)return Promise.reject("No identity token");if(!c.nonce)return Promise.reject("No nonce loaded")}if(c.oauth){if(!d.access_token)return Promise.reject("No access token");if(!d.token_type||"bearer"!==d.token_type.toLowerCase())return Promise.reject("Invalid token type");if(!d.expires_in)return Promise.reject("No token expiration")}var e=Promise.resolve();return c.oidc&&c.oauth?e=this.validateIdTokenAndAccessTokenAsync(d.id_token,c.nonce,d.access_token):c.oidc&&(e=this.validateIdTokenAsync(d.id_token,c.nonce)),e.then(function(a){if(a&&b.filter_protocol_claims){var c=["nonce","at_hash","iat","nbf","exp","aud","iss"];c.forEach(function(b){delete a[b]})}return{profile:a,id_token:d.id_token,access_token:d.access_token,expires_in:d.expires_in,scope:d.scope,session_state:d.session_state}})}},{key:"_httpRequest",get:function(){return"undefined"!=typeof this.httpRequest&&null!==this.httpRequest||(this.httpRequest=new h),this.httpRequest}},{key:"isOidc",get:function(){if(this._settings.response_type){var a=this._settings.response_type.split(/\s+/g).filter(function(a){return"id_token"===a});return!!a[0]}return!1}},{key:"isOAuth",get:function(){if(this._settings.response_type){var a=this._settings.response_type.split(/\s+/g).filter(function(a){return"token"===a});return!!a[0]}return!1}}]),a}();i.parseOidcResult=g.parseOidcResult,a.OidcClient=i});